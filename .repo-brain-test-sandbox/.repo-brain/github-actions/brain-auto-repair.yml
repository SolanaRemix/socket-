name: ü§ñ Brain Auto-Repair
# Generated by REPO BRAIN HOSPITAL v2.2.0
# Automated repair workflow for AUTO_FIXABLE status

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:
  push:
    branches: [ main, master ]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  brain-scan:
    name: üîç Scan Repository Health
    runs-on: ubuntu-latest
    outputs:
      needs-repair: ${{ steps.check.outputs.needs-repair }}
      status: ${{ steps.check.outputs.status }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Full Brain Pipeline
        run: |
          bash .repo-brain/brain.run.sh || echo "Pipeline completed"
      
      - name: Check if Repair Needed
        id: check
        run: |
          status=$(jq -r '.status' .repo-brain/diagnosis.json 2>/dev/null || echo "UNKNOWN")
          echo "status=$status" >> $GITHUB_OUTPUT
          
          if [ "$status" = "AUTO_FIXABLE" ]; then
            echo "needs-repair=true" >> $GITHUB_OUTPUT
            echo "üîß Repository requires auto-repair"
          else
            echo "needs-repair=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No repair needed (status: $status)"
          fi

  brain-repair:
    name: üîß Auto-Repair Infrastructure
    needs: brain-scan
    if: needs.brain-scan.outputs.needs-repair == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config user.name "Brain Bot"
          git config user.email "brain-bot@cyberai.network"
      
      - name: Run Safe Repairs
        run: |
          bash .repo-brain/brain.fix.safe.sh
          bash .repo-brain/brain.normalize.sh
      
      - name: Verify Repairs
        run: |
          bash .repo-brain/brain.verify.sh
      
      - name: Create Repair Branch
        id: branch
        run: |
          branch_name="brain/auto-repair-$(date +%Y%m%d-%H%M%S)"
          echo "branch=$branch_name" >> $GITHUB_OUTPUT
          git checkout -b "$branch_name"
      
      - name: Commit Changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "ü§ñ Brain Auto-Repair: Infrastructure normalization

            - Synchronized CI/CD workflows
            - Applied MERMEDA v2.2.0 standards
            - Fixed configuration drift

            Generated by REPO BRAIN HOSPITAL
            Status: AUTO_FIXABLE ‚Üí GREEN"
          else
            echo "No changes to commit"
            exit 0
          fi
      
      - name: Push Changes
        run: |
          git push origin ${{ steps.branch.outputs.branch }}
      
      - name: Create Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "ü§ñ Brain Auto-Repair: Infrastructure Normalization" \
            --body "## üß† REPO BRAIN HOSPITAL - Automated Repair

          This PR was automatically generated by the Brain Auto-Repair system.

          ### Changes Made
          - üîß Synchronized CI/CD workflows with MERMEDA v2.2.0
          - ‚úÖ Applied canonical configuration standards
          - üõ°Ô∏è Fixed infrastructure drift

          ### Diagnosis
          - **Previous Status**: AUTO_FIXABLE
          - **Expected Status**: GREEN
          - **Framework**: $(jq -r '.framework' .repo-brain/diagnosis.json)
          - **Languages**: $(jq -r '.languages | join(", ")' .repo-brain/diagnosis.json)

          ### Review Instructions
          1. Review the workflow changes
          2. Ensure all CI checks pass
          3. Merge if approved by AI Guard

          ---
          ü§ñ Powered by CyberAI Oracle Network ‚Ä¢ www.CyberAi.network" \
            --base main \
            --head ${{ steps.branch.outputs.branch }} \
            --label "brain-auto-repair,automerge"
